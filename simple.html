<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èŠ±è“®å…‰å¾©é„‰äº’åŠ©ç¶²</title>

  <!-- React / Babel / Tailwind -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet & toGeoJSON (KML è½‰ GeoJSON) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.umd.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%23ef4444'/%3E%3C/svg%3E" />
  <style>
    html,body,#root{height:100%}
    .animate-marquee{display:inline-block;min-width:100%;animation:marquee 30s linear infinite}
    @keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
    .leaflet-container{background:#f8fafc; z-index:1}
    .ui-over{position:relative; z-index:10}
    .modal-z{z-index:50}
    .leaflet-popup{z-index:60}
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useCallback, useRef, useMemo } = React;

  /* ---------------- å¸¸æ•¸ / å…¬ç”¨ ---------------- */
  const RequestType = { VOLUNTEER: 'å¿—å·¥äººåŠ›', SUPPLY: 'ç‰©è³‡éœ€æ±‚' };
  const RequestStatus = { NEW:'æ–°ç™»è¨˜', IN_PROGRESS:'è™•ç†ä¸­', COMPLETED:'å·²å®Œæˆ', CANCELLED:'å·²å–æ¶ˆ' };
  const FeedbackStatus = { PENDING:'æœªè™•ç†', DOING:'è™•ç†ä¸­', DONE:'å·²å®Œæˆ' };

  // å¯é¸ï¼šå¾ <meta name="admin-token" content="..."> æˆ– localStorage è®€å–ç®¡ç†é‡‘é‘°
  const ADMIN_TOKEN = (document.querySelector('meta[name="admin-token"]')?.content) || localStorage.getItem('ADMIN_TOKEN') || '';
  const adminAuthHeader = ADMIN_TOKEN ? { Authorization: 'Bearer ' + ADMIN_TOKEN } : {};

  // å°å—ä¿è­·ç«¯é»è‡ªå‹•å¤¾å¸¶ Authorizationï¼ˆè‹¥æœ‰ ADMIN_TOKENï¼‰
  (function patchFetchForAdmin(){
    if (!ADMIN_TOKEN) return; // ç„¡é‡‘é‘°å‰‡ä¸å‹•
    const orig = window.fetch;
    window.fetch = function(input, init){
      try {
        const url = typeof input === 'string' ? input : (input?.url || '');
        const method = (init?.method || 'GET').toUpperCase();
        const isProtected = (
          // éœ€æ±‚ï¼šæ›´æ–°ç‹€æ…‹ã€åˆªé™¤
          (/^\/api\/requests\/[^/]+\/status/.test(url) && (method==='PATCH')) ||
          (/^\/api\/requests\/[^/]+$/.test(url) && (method==='DELETE')) ||
          (/^\/api\/requests\/[^/]+\/delete$/.test(url)) ||
          // æ„è¦‹ï¼šæ›´æ–°ã€åˆªé™¤
          (/^\/api\/feedback\/[^/]+\/status/.test(url) && (method==='PATCH')) ||
          (/^\/api\/feedback\/[^/]+$/.test(url) && (method==='DELETE'))
        );
        if (isProtected) {
          const headers = new Headers(init?.headers || {});
          if (!headers.has('Authorization')) headers.set('Authorization', 'Bearer ' + ADMIN_TOKEN);
          return orig(input, { ...(init||{}), headers });
        }
      } catch {}
      return orig(input, init);
    };
  })();

  // å‰ç«¯é®è”½ï¼šåƒ…é¡¯ç¤ºé›»è©±æœ« 3-4 ç¢¼
  function maskPhone(p){
    const s = String(p||'').trim();
    if(!s) return '';
    if(s.length<=4) return '*'.repeat(Math.max(0,s.length-1)) + s.slice(-1);
    const keep = s.length>=10 ? 4 : 3;
    return s.slice(0, Math.max(0, s.length-keep)).replace(/\S/g,'*') + s.slice(-keep);
  }

  const CENTER = { lat: 23.6697, lon: 121.4235 };
  const WAQI_TOKEN = 'demo';
  const MYMAPS_MID = '1qOHK91tv68NacIN1GVTDYKn10ojb-t8';
  const KML_URL = `https://www.google.com/maps/d/kml?mid=${MYMAPS_MID}&forcekml=1`;
  const KML_FALLBACK = `https://www.google.com/maps/d/kml?mid=${MYMAPS_MID}&forcekml=1`;
  const SHOVEL_JSON = '/api/proxy/shovel';
  const GOV_POINTS_URL = 'https://tainan.olc.tw/p/guangfu250923/data/government_points.json';
  const WRA_LEVEL_API = '/api/proxy/wra/realtime-water-level';
  const GEO_CACHE_KEY = 'gf_geo_cache_v4';
  const GEO_FAIL_KEY  = 'gf_geo_fail_v1';

  // å¤–éƒ¨è³‡æºé€£çµ
  const EXTERNAL_LINKS = [
    { name:'å…‰å¾©ç½æƒ…æ•´åˆç¶²', url:'https://sites.google.com/view/guangfu250923/home?authuser=0' },
    { name:'æ•‘ç½åˆ—è¡¨åœ°åœ–',   url:'https://tainan.olc.tw/p/guangfu250923/#db7bcdce-b986-4128-a9ab-98d1f6b14b36' },
    { name:'æ´—æ¾¡é»',         url:'https://sites.google.com/view/guangfu250923/%E7%8F%BE%E5%A0%B4%E4%BA%BA%E5%93%A1%E6%AC%B2%E6%8F%90%E4%BE%9B%E8%B3%87%E6%BA%90/shower_locations?authuser=0' },
    { name:'ä½å®¿é»',         url:'https://sites.google.com/view/guangfu250923/%E7%8F%BE%E5%A0%B4%E4%BA%BA%E5%93%A1%E6%AC%B2%E6%8F%90%E4%BE%9B%E8%B3%87%E6%BA%90/hotel?authuser=0' },
  ];

  // æ‰‹å‹•åº‡è­·æ‰€ï¼ˆä»¥åœ°å€å®šä½ï¼‰
  const SHELTER_PRESETS = [
    { name:'å…‰å¾©åœ‹å°', address:'èŠ±è“®ç¸£å…‰å¾©é„‰ä¸­å±±è·¯ä¸‰æ®µ75è™Ÿ' },
    { name:'æ±è±éƒ¨è½', address:'èŠ±è“®ç¸£å…‰å¾©é„‰æ±å¯Œè·¯5è™Ÿ' },
    { name:'é˜¿é™¶è«éƒ¨è½', address:'èŠ±è“®ç¸£å…‰å¾©é„‰æ±å¯Œè·¯19è™Ÿ' },
    { name:'å¤§é€²åœ‹å°æ”¶å®¹ä¸­å¿ƒå®‰å¿ƒç«™', address:'èŠ±è“®ç¸£å…‰å¾©é„‰ç³–å» è¡—4è™Ÿ' },
    { name:'èŠ±è“®åŒé„‰å…¬ç›Šç¸½æœƒ', address:'èŠ±è“®ç¸£å‰å®‰é„‰å’Œå¹³è·¯ä¸€æ®µ55è™Ÿ' },
    { name:'ç‘ç©—è™çˆºæº«æ³‰', address:'èŠ±è“®ç¸£ç‘ç©—é„‰ç¥¥åŒ—è·¯äºŒæ®µ101-5è™Ÿ' },
    { name:'é¦¬å¤ªéé•·è€æ•™æœƒ', address:'èŠ±è“®ç¸£å…‰å¾©é„‰å¤§é¦¬æ‘ä¸­å±±è·¯ä¸‰æ®µ89å··14è™Ÿ' },
    { name:'èŠ±è“®ç¸£å…‰å¾©é„‰æ±å¯Œæ‘', address:'èŠ±è“®ç¸£å…‰å¾©é„‰å¯Œç”°ä¸‰è¡—21è™Ÿ' },
    { name:'å…‰å¾©é„‰ç½å®³æ‡‰è®Šä¸­å¿ƒ', address:'èŠ±è“®ç¸£å…‰å¾©é„‰å¤§é€²æ‘ç³–å» è¡—19è™Ÿ' },
    { name:'èŠ±è“®ç³–å» ä¸­å¤®å€‰åº«', address:'èŠ±è“®ç¸£å…‰å¾©é„‰ç³–å» è¡—19è™Ÿ' },
    { name:'èŠ±è“®å…‰å¾©é„‰å¤©ä¸»å ‚', address:'èŠ±è“®ç¸£å…‰å¾©é„‰å¯Œç”°ä¸€è¡—16è™Ÿ' },
    { name:'å¤ªå·´å¡±æ•™æœƒæ”¯æ´ä¸­å¿ƒç«™', address:'èŠ±è“®ç¸£å…‰å¾©é„‰ä¸­æ­£è·¯äºŒæ®µ90è™Ÿ' },
    { name:'ç‘ç©—ç”Ÿå‘½åœ’å€', address:'èŠ±è“®ç¸£ç‘ç©—é„‰ä»æ„›è·¯234è™Ÿ' },
    { name:'å¤§å®‰æ´»å‹•ä¸­å¿ƒ', address:'èŠ±è“®ç¸£å…‰å¾©é„‰å¿ å­è·¯23å··11è™Ÿ1æ¨“' }
  ];

  // CSVè³‡æ–™é›†
  const DATASETS = [
    {key:'baths',    label:'æ´—æ¾¡é»',   color:'#0ea5e9', csv:'Data/å…‰å¾©å¿—å·¥æ´—æ¾¡é».csv', icon:'ğŸš¿'},
    {key:'shelters', label:'åº‡è­·æ‰€',   color:'#10b981', csv:'Data/åº‡è­·æ‰€è³‡è¨Š.csv',     icon:'ğŸ›ï¸'},
    {key:'lodging',  label:'ä½å®¿',     color:'#f59e0b', csv:'Data/å„ªå¾…ä½å®¿é».csv',     icon:'ğŸ›ï¸'},
    {key:'medical',  label:'é†«ç™‚',     color:'#ef4444', csv:'Data/é†«ç™‚ç«™åˆ—è¡¨.csv',     icon:'ğŸ©º'},
    {key:'mental',   label:'å¿ƒç†',     color:'#8b5cf6', csv:'Data/å¿ƒç†å¥åº·è³‡æº.csv',   icon:'ğŸ’š'}
  ];

  const LS_USER_ADDS  = 'gf_user_adds_v1';

  // CSVæ¬„ä½å·¥å…·
  const tryPick = (row, names) => {
    for (const n of names) {
      const hit = Object.keys(row).find(k => k.trim().toLowerCase() === n.toLowerCase());
      if (hit && String(row[hit]).trim()!=='') return row[hit];
    }
    for (const k of Object.keys(row)) {
      const kk = k.trim();
      if (names.some(n => kk.includes(n))) {
        const v = row[k];
        if (v!=null && String(v).trim()!=='') return v;
      }
    }
    return '';
  };
  const toNumber = (v)=> {
    const n = Number(String(v).replace(/[^\d\.\-]/g,''));
    return isFinite(n) ? n : NaN;
  };
  const detectLatLng = (row) => {
    const lat = tryPick(row, ['lat','latitude','ç·¯åº¦']);
    const lng = tryPick(row, ['lng','lon','long','longitude','ç¶“åº¦']);
    return {lat: toNumber(lat), lng: toNumber(lng)};
  };

  async function parseJSONResponse(res, fallbackMessage) {
    const text = await res.text();
    if (!res.ok) {
      let message = fallbackMessage;
      try {
        const data = text ? JSON.parse(text) : null;
        if (data?.error) message = data.error;
      } catch {}
      throw new Error(message);
    }
    return text ? JSON.parse(text) : null;
  }

  // ---- åœ°ç†ç·¨ç¢¼ï¼ˆåªç”¨åœ°å€ï¼‰ ----
  function normalizeAddress(addr) {
    let a = (addr || '').trim();
    if (!a) return '';
    a = a.replace(/æ­£å°é¢|å°é¢|é™„è¿‘|ç´„\d+åˆ†é˜.+è»Šç¨‹|é–‹æ”¾æ™‚é–“.+|åƒ…é–‹æ”¾.+/g, '');
    a = a.replace(/[()ï¼ˆï¼‰]/g, ' ');
    a = a.replace(/\s+/g, ' ').trim();
    const hualienTowns = ['å…‰å¾©é„‰','å‰å®‰é„‰','é³³æ—é®','ç‘ç©—é„‰','è¬æ¦®é„‰','æ–°åŸé„‰','ç‰é‡Œé®','å¯Œé‡Œé„‰','è±æ¿±é„‰','å£½è±é„‰','èŠ±è“®å¸‚'];
    if (hualienTowns.some(t => a.includes(t)) && !a.includes('èŠ±è“®ç¸£') && !a.includes('èŠ±è“®å¸‚')) {
      a = 'èŠ±è“®ç¸£ ' + a;
    }
    if (a.includes('å…‰å¾©è»Šç«™')) a = 'å…‰å¾©è»Šç«™ èŠ±è“®ç¸£å…‰å¾©é„‰';
    if (!/å°ç£|è‡ºç£|Taiwan/i.test(a)) a = a + ' å°ç£';
    return a;
  }
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
  function isInTaiwanBox(lat, lng) { return isFinite(lat) && isFinite(lng) && lat>=21.5 && lat<=25.5 && lng>=119 && lng<=123.6; }

  async function geocodeNominatim(q) {
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','json'); url.searchParams.set('q', q);
    url.searchParams.set('limit','1'); url.searchParams.set('countrycodes','tw');
    url.searchParams.set('viewbox', `${120.9},${24.9},${122.3},${22.8}`);
    url.searchParams.set('bounded','1');
    try {
      const r = await fetch(url.toString(), { headers: { 'Accept':'application/json' } });
      if (r.ok) {
        const arr = await r.json();
        if (Array.isArray(arr) && arr.length) {
          const lat = Number(arr[0].lat), lng = Number(arr[0].lon);
          if (isInTaiwanBox(lat,lng)) return {lat,lng, src:'nominatim'};
        }
      }
    } catch {}
    return null;
  }
  async function geocodeMapsCo(q) {
    try {
      const r = await fetch('https://geocode.maps.co/search?q=' + encodeURIComponent(q));
      if (r.ok) {
        const arr = await r.json();
        if (Array.isArray(arr) && arr.length) {
          const lat = Number(arr[0].lat), lng = Number(arr[0].lon);
          if (isInTaiwanBox(lat,lng)) return {lat,lng, src:'maps.co'};
        }
      }
    } catch {}
    return null;
  }
  async function geocodePhoton(q) {
    try {
      const r = await fetch('https://photon.komoot.io/api/?q=' + encodeURIComponent(q) + '&lang=zh');
      if (r.ok) {
        const j = await r.json();
        const f = j?.features?.[0];
        if (f?.geometry?.coordinates?.length===2) {
          const [lng,lat] = f.geometry.coordinates;
          if (isInTaiwanBox(lat,lng)) return {lat, lng, src:'photon'};
        }
      }
    } catch {}
    return null;
  }

  async function geocodeAddress(address) {
    const addr = normalizeAddress(address);
    if (!addr) return null;
    const cache = JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}');
    if (cache[addr]) return cache[addr];
    const failed = JSON.parse(localStorage.getItem(GEO_FAIL_KEY) || '[]');
    if (failed.includes(addr)) return null;

    const tries = [geocodeNominatim, geocodeMapsCo, geocodePhoton];
    let res = null;
    for (const fn of tries) {
      res = await fn(addr);
      if (res) break;
      await sleep(400);
    }
    if (res) {
      cache[addr] = { lat: res.lat, lng: res.lng };
      localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache));
      return cache[addr];
    } else {
      failed.push(addr);
      localStorage.setItem(GEO_FAIL_KEY, JSON.stringify(failed.slice(-200)));
    }
    return null;
  }

  /* ---------------- æ¨™é ­ ---------------- */
  const Header = () => (
    <header className="bg-white shadow-md ui-over">
      <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-bold text-slate-800">èŠ±è“®å…‰å¾©é„‰ ç½æƒ…äº’åŠ©å¹³å°</h1>
          <div className="hidden md:flex items-center gap-2">
            {EXTERNAL_LINKS.map(l=>(
              <a key={l.url} href={l.url} target="_blank" rel="noopener" className="text-xs px-2 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">{l.name}</a>
            ))}
            <button id="open-feedback" className="text-xs px-2 py-1 rounded bg-purple-600 text-white hover:bg-purple-700">ğŸ’¬ ç¶²ç«™æ„è¦‹</button>
          </div>
        </div>
      </div>
    </header>
  );

  /* ---------------- è·‘é¦¬ç‡ˆ ---------------- */
  const EmergencyTicker = () => {
    const [items, setItems] = useState([]);
    useEffect(() => {
      const load = async () => {
        const list = [];
        try {
          const url = new URL('https://api.open-meteo.com/v1/forecast');
          url.searchParams.set('latitude', CENTER.lat);
          url.searchParams.set('longitude', CENTER.lon);
          url.searchParams.set('hourly','temperature_2m,wind_speed_10m,precipitation');
          url.searchParams.set('timezone','Asia/Taipei');
          const w = await fetch(url).then(r=>r.json());
          const last = w.hourly.time.length - 1;
          list.push({source:'æ°£æº«', title:`${Math.round(w.hourly.temperature_2m[last])}Â°C`});
          list.push({source:'é¢¨é€Ÿ', title:`${Math.round(w.hourly.wind_speed_10m[last])} km/h`});
          list.push({source:'æ™‚é›¨é‡', title:`${(w.hourly.precipitation[last]||0).toFixed(1)} mm`});
        } catch {}
        try {
          const aqiUrl = `https://api.waqi.info/feed/geo:${CENTER.lat};${CENTER.lon}/?token=${WAQI_TOKEN}`;
          const aqi = await fetch(aqiUrl).then(r=>r.json());
          if (aqi?.status === 'ok') list.push({source:'AQI', title:String(aqi.data.aqi)});
        } catch {}
        setItems(list);
      };
      load();
      const t = setInterval(load, 60000);
      return ()=>clearInterval(t);
    }, []);
    const text = items.slice(0, 12).map(i => `ã€${i.source}ã€‘${i.title}`).join(' ï½œ ');
    return (
      <div className="bg-red-600 text-white text-sm py-2 overflow-hidden">
        <div className="animate-marquee whitespace-nowrap px-4">{text || 'è³‡æ–™è¼‰å…¥ä¸­â€¦'}</div>
      </div>
    );
  };

  /* ---------------- æ°£è±¡ / æ°´ä½ ---------------- */
  const WeatherAlert = () => {
    const [data, setData] = useState(null);
    const load = async () => {
      try {
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.searchParams.set('latitude', CENTER.lat);
        url.searchParams.set('longitude', CENTER.lon);
        url.searchParams.set('hourly','temperature_2m,relative_humidity_2m,wind_speed_10m,precipitation');
        url.searchParams.set('timezone','Asia/Taipei');
        const w = await fetch(url).then(r=>r.json());
        const last = w.hourly.time.length - 1;

        let rain24h = 0;
        if (w.hourly?.precipitation?.length) {
          rain24h = w.hourly.precipitation.slice(Math.max(0,last-23), last+1).reduce((s,v)=>s+(Number(v)||0),0);
          rain24h = Math.round(rain24h*10)/10;
        }

        let aqi = null;
        try {
          const aqiUrl = `https://api.waqi.info/feed/geo:${CENTER.lat};${CENTER.lon}/?token=${WAQI_TOKEN}`;
          const a = await fetch(aqiUrl).then(r=>r.json());
          if (a?.status==='ok') aqi = a.data.aqi;
        } catch {}

        let riverLevel = null, riverStatus = 'normal', riverStation = '';
        try {
          const r = await fetch(WRA_LEVEL_API);
          if (r.ok) {
            const arr = await r.json();
            const hl = (Array.isArray(arr) ? arr : []).filter(s => String(s?.County||'').includes('èŠ±è“®'));
            let best=null, bestd=1e9;
            for(const s of hl){
              const dlat = (s.StationLatitude||s.Latitude||0) - CENTER.lat;
              const dlng = (s.StationLongitude||s.Longitude||0) - CENTER.lon;
              const d = Math.hypot(dlat, dlng);
              if (d<bestd){best=s; bestd=d;}
            }
            const target = best || null;
            if (target?.WaterLevel) {
              riverLevel = Number(target.WaterLevel);
              riverStation = target.StationName || target.SiteName || '';
              riverStatus = riverLevel > 4 ? 'warning' : riverLevel > 3 ? 'watch' : 'normal';
            }
          }
        } catch {}

        setData({
          rainfall24h: rain24h,
          rainfallHourly: Math.round((w.hourly.precipitation[last]||0)*10)/10,
          windSpeed: Math.round(w.hourly.wind_speed_10m[last]||0),
          temperature: Math.round(w.hourly.temperature_2m[last]||0),
          humidity: Math.round(w.hourly.relative_humidity_2m[last]||0),
          airQuality: aqi ?? 'â€”',
          riverLevel, riverStatus, riverStation,
          lastUpdate: new Date().toISOString(),
          dataSource: 'Open-Meteo / WAQI / WRA'
        });
      } catch (e) { console.error(e); }
    };
    useEffect(()=>{ load(); const t=setInterval(load,60000); return ()=>clearInterval(t)},[]);
    if (!data) return null;

    const color =
      data.riverStatus==='warning' ? 'bg-red-50 border-red-200 text-red-800' :
      data.riverStatus==='watch'   ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                                     'bg-green-50 border-green-200 text-green-800';

    const statusText =
      data.riverStatus==='warning' ? 'ğŸš¨ æºªæ°´æš´æ¼²è­¦å ±' :
      data.riverStatus==='watch'   ? 'âš ï¸ æºªæ°´ä¸Šæ¼²æ³¨æ„' : 'âœ… æºªæ°´ç‹€æ³æ­£å¸¸';

    const Box = ({label, val, sub}) => (
      <div className="bg-white rounded-lg p-3 text-center">
        <div className="text-xs text-gray-600 mb-1">{label}</div>
        <div className="text-xl font-bold">{val}</div>
        {sub ? <div className="text-xs text-gray-500">{sub}</div> : null}
      </div>
    );

    return (
      <div className={`rounded-lg p-4 mb-6 ${color} ui-over`}>
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-bold">ğŸŒ§ï¸ å³æ™‚æ°£è±¡ / ç©ºæ°£ / æ°´ä½</h3>
          <span className="text-sm font-medium">{statusText}</span>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
          <Box label="æ™‚é›¨é‡" val={`${data.rainfallHourly} mm`} />
          <Box label="24h ç´¯ç©" val={`${data.rainfall24h} mm`} />
          <Box label={`æºªæ°´æ°´ä½${data.riverStation?`ï¼ˆ${data.riverStation}ï¼‰`:''}`} val={data.riverLevel!=null?`${data.riverLevel.toFixed(2)} m`:'â€”'} sub="æ°´åˆ©ç½² / ç´„10åˆ†é˜" />
          <Box label="AQI" val={data.airQuality} />
          <Box label="æº«åº¦" val={`${data.temperature}Â°C`} />
          <Box label="æ¿•åº¦" val={`${data.humidity}%`} />
        </div>
        <div className="mt-3 flex justify-between items-center text-xs opacity-75">
          <span>æœ€å¾Œæ›´æ–°ï¼š{new Date(data.lastUpdate).toLocaleString('zh-TW')}</span>
          <span>è³‡æ–™ä¾†æºï¼š{data.dataSource}</span>
        </div>
      </div>
    );
  };

  /* ---------------- å®˜æ–¹ My Maps å½ˆçª— ---------------- */
  const DisasterMap = ({ isOpen, onClose }) => {
    if (!isOpen) return null;
    return (
      <div className="fixed inset-0 bg-black/50 modal-z flex items-center justify-center p-4">
        <div className="bg-white rounded-lg w-full max-w-6xl h-5/6 relative">
          <div className="flex items-center justify-between p-4 border-b">
            <h3 className="text-lg font-bold">å…‰å¾©é„‰ç½æƒ…æ•´åˆåœ°åœ–ï¼ˆå®˜æ–¹ My Mapsï¼‰</h3>
            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-xl">âœ•</button>
          </div>
          <div className="h-full p-4">
            <iframe
              src={`https://www.google.com/maps/d/embed?mid=${MYMAPS_MID}&ehbc=2E312F`}
              width="100%" height="90%" style={{ border: 0 }}
              allowFullScreen loading="lazy"></iframe>
            <div className="mt-2 text-xs text-gray-500 text-center">åŒ…å«äº¤é€šç®¡åˆ¶ã€ç‰©è³‡ã€é†«ç™‚ã€ä¾›æ°´â€¦ç­‰åœ–å±¤</div>
          </div>
        </div>
      </div>
    );
  };

  // å…¶ä»–ç¶²ç«™ä»»å‹™ï¼ˆShovelï¼‰è¦–çª—
  const ShovelModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;
    return (
      <div className="fixed inset-0 bg-black/50 modal-z flex items-center justify-center p-4">
        <div className="bg-white rounded-lg w-full max-w-6xl h-5/6 relative">
          <div className="flex items-center justify-between p-4 border-b">
            <h3 className="text-lg font-bold">å…¶ä»–ç¶²ç«™æ•‘ç½ä»»å‹™ï¼ˆShovel Heroesï¼‰</h3>
            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-xl">âœ•</button>
          </div>
          <div className="p-3 text-xs text-slate-600">æ­¤ç‚ºå¤–éƒ¨ç¤¾ç¾¤ç¶­è­·ä¹‹ä»»å‹™åˆ—è¡¨ï¼Œå…§å®¹ç”±è©²ç«™ç¶­è­·ã€‚è‹¥ç„¡æ³•åµŒå…¥é¡¯ç¤ºï¼Œè«‹æ”¹ç”¨ä¸‹æ–¹æŒ‰éˆ•åœ¨æ–°åˆ†é é–‹å•Ÿã€‚</div>
          <div className="h-full p-4">
            <iframe src="https://shovel-heroes.com/" title="Shovel Heroes" width="100%" height="90%" style={{border:0}} allowFullScreen loading="lazy"></iframe>
            <div className="mt-2 text-xs text-gray-500 text-center">
              <a className="text-blue-600 underline" href="https://shovel-heroes.com/" target="_blank" rel="noopener">åœ¨æ–°åˆ†é é–‹å•Ÿ shovel-heroes.com</a>
            </div>
          </div>
        </div>
      </div>
    );
  };

  /* ---------------- åœ°åœ–ä¸»é¢æ¿ ---------------- */
  const LeafletMapPanel = ({requests}) => {
    const mapRef = useRef(null);
    const layerRef = useRef({
      kml:null, user:null, req:null, shovel:null, gov:null, manualShelters:null,
      csv:{ baths:null, shelters:null, lodging:null, medical:null, mental:null }
    });
    const [list, setList] = useState([]);
    const [filterKey, setFilterKey] = useState('å…¨éƒ¨');
    const [search, setSearch] = useState('');
    const [showOfficial, setShowOfficial] = useState(false);
    const [csvVisible, setCsvVisible] = useState({ baths:true, shelters:true, lodging:true, medical:true, mental:true });
    const [showAddForm, setShowAddForm] = useState(false);
    const lastGeoRef = useRef(0); // geocode ç¯€æµ

    // åˆå§‹åœ°åœ–
    useEffect(() => {
      const m = L.map('gf-map', { center:[CENTER.lat, CENTER.lon], zoom:12 });
      mapRef.current = m;
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(m);

      // Layer groups
      layerRef.current.kml     = L.layerGroup().addTo(m);
      layerRef.current.user    = L.layerGroup().addTo(m);
      layerRef.current.req     = L.layerGroup().addTo(m);
      layerRef.current.shovel  = L.layerGroup().addTo(m);
      layerRef.current.gov     = L.layerGroup().addTo(m);
      layerRef.current.manualShelters = L.layerGroup().addTo(m);
      layerRef.current.csv.baths    = L.layerGroup().addTo(m);
      layerRef.current.csv.shelters = L.layerGroup().addTo(m);
      layerRef.current.csv.lodging  = L.layerGroup().addTo(m);
      layerRef.current.csv.medical  = L.layerGroup().addTo(m);
      layerRef.current.csv.mental   = L.layerGroup().addTo(m);

      return ()=> m.remove();
    }, []);

    const locateMe = useCallback(()=>{
      const m = mapRef.current; if (!m) return;
      if (!navigator.geolocation) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude, longitude } = pos.coords;
        m.flyTo([latitude, longitude], 15);
        L.circleMarker([latitude,longitude], {radius:8,color:'#059669',fillColor:'#10b981',fillOpacity:.8,weight:2})
          .addTo(m).bindPopup('ä½ åœ¨é€™è£¡').openPopup();
      },()=>alert('å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™'));
    }, []);

    // geocode ç¯€æµï¼ˆ1.5s/æ¬¡ï¼‰
    const geocodeWithThrottle = useCallback(async (q)=>{
      const now = Date.now();
      const wait = Math.max(0, 1500 - (now - lastGeoRef.current));
      if (wait) await sleep(wait);
      const res = await geocodeAddress(q);
      lastGeoRef.current = Date.now();
      return res;
    }, []);

    // è®€CSVä¸¦ç•«åœ–å±¤ï¼ˆåªç”¨åœ°å€å®šä½ï¼›æ²’åœ°å€å°±è·³éï¼‰
    const drawCsvLayers = useCallback(async()=>{
      Object.values(layerRef.current.csv).forEach(g => g?.clearLayers());
      const newItems = [];

      for (const ds of DATASETS) {
        if (!csvVisible[ds.key]) continue;
        try {
          const res = await fetch(ds.csv);
          if (!res.ok) continue;
          const text = await res.text();
          const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
          const rows = parsed.data || [];
          for (let idx=0; idx<rows.length; idx++) {
            const row = rows[idx];
            let {lat,lng} = detectLatLng(row);
            const name = tryPick(row, ['åç¨±','é»ä½','å ´æ‰€','name','title']) || `æœªå‘½å(${idx+1})`;
            const addressRaw = tryPick(row, ['åœ°å€','ä½å€','address','addr']).trim();
            const phone = tryPick(row, ['é›»è©±','è¯çµ¡é›»è©±','phone','tel']);
            const note = tryPick(row, ['å‚™è¨»','èªªæ˜','æè¿°','note','desc','å…§å®¹','content']);

            // ä»¥åœ°å€ç‚ºä¸»ï¼Œæ²’æœ‰åœ°å€å°±ä¸å˜—è©¦åç¨±å®šä½
            let finalAddr = addressRaw;
            if ((!isFinite(lat) || !isFinite(lng)) && finalAddr) {
              const g = await geocodeWithThrottle(finalAddr);
              if (g) { lat = g.lat; lng = g.lng; }
            }
            if (!isFinite(lat) || !isFinite(lng)) continue;
            if (!isInTaiwanBox(lat, lng)) continue;

            const icon = L.divIcon({
              className:'custom-pin',
              html:`<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${ds.color};border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.3)"></span>`,
              iconSize:[16,16], iconAnchor:[8,8]
            });
            const marker = L.marker([lat,lng],{icon}).addTo(layerRef.current.csv[ds.key]);
            const noteHtml = note ? `<div class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">${note}</div>` : '';
            const phoneHtml = phone ? `<div class="text-xs text-gray-600">ğŸ“ ${maskPhone(phone)}</div>` : '';
            const addrHtml = finalAddr ? `<div class="text-xs text-gray-600">ğŸ“ ${finalAddr}</div>` : '';
            marker.bindPopup(`<div class="text-sm">
              <div class="font-medium mb-1">${name} <span class="text-[10px] text-gray-500">ï¼ˆ${ds.label}ï¼‰</span></div>
              ${addrHtml}${phoneHtml}${noteHtml}
              <a class="text-blue-600 underline text-xs" target="_blank" rel="noopener" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">ğŸ§­ å°èˆª</a>
            </div>`);
            newItems.push({ id: `${ds.key}::csv::${idx}`, source:'CSV', key:ds.key, name, address: finalAddr, phone, note, latlng:L.latLng(lat,lng), layer:marker, type:ds.label });
          }
        } catch(e){ console.warn('csv load failed:', ds.csv, e); }
      }
      setList(prev => [...prev.filter(x=>x.source!=='CSV'), ...newItems]);
    }, [csvVisible, geocodeWithThrottle]);

    // ç¹ªè£½æ‰‹å‹•åº‡è­·æ‰€ï¼ˆåªç”¨åœ°å€å®šä½ï¼‰
    const drawManualShelters = useCallback(async()=>{
      const g = layerRef.current.manualShelters; if (!g) return;
      g.clearLayers();
      // å…ˆå´æ¬„ä½”ä½
      setList(prev => [
        ...prev.filter(x=>x.source!=='æ‰‹å‹•'),
        ...SHELTER_PRESETS.map(s=>({ id:'manual::'+s.name, source:'æ‰‹å‹•', name:s.name, address:s.address, latlng:null, layer:null, type:'åº‡è­·æ‰€', pending:true }))
      ]);

      for (const s of SHELTER_PRESETS) {
        try {
          const geo = await geocodeWithThrottle(s.address);
          if (!geo) continue;
          const { lat, lng } = geo;
          if (!isInTaiwanBox(lat, lng)) continue;

          const icon = L.divIcon({
            className:'',
            html:`<span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#10b981;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.3)"></span>`,
            iconSize:[18,18], iconAnchor:[9,9]
          });
          const mk = L.marker([lat,lng], {icon}).addTo(g).bindPopup(`
            <div class="text-sm">
              <div class="font-medium mb-1">${s.name} <span class="text-[10px] text-gray-500">ï¼ˆåº‡è­·æ‰€ï¼‰</span></div>
              <div class="text-xs text-gray-600">ğŸ“ ${s.address}</div>
              <a class="text-blue-600 underline text-xs" target="_blank" rel="noopener" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">ğŸ§­ å°èˆª</a>
            </div>`);
          setList(prev => {
            const rest = prev.filter(x => x.id!=='manual::'+s.name);
            return [...rest, { id:'manual::'+s.name, source:'æ‰‹å‹•', name:s.name, address:s.address, latlng:L.latLng(lat,lng), layer:mk, type:'åº‡è­·æ‰€', pending:false }];
          });
        } catch(e) { console.warn('manual shelter fail', s, e); }
      }
    }, [geocodeWithThrottle]);

    // å…¶ä»–éœæ…‹è³‡æ–™
    const redrawStatic = useCallback(async()=>{
      if (!mapRef.current) return;
      const items = [];

      layerRef.current.kml?.clearLayers();
      layerRef.current.shovel?.clearLayers();
      layerRef.current.gov?.clearLayers();
      layerRef.current.user?.clearLayers();
      layerRef.current.req?.clearLayers();

      // KMLï¼ˆä¿è­·æ€§è¼‰å…¥ï¼‰
      try {
        if (window.toGeoJSON) {
          const kmlTxt = await fetchKMLText();
          const xml = new DOMParser().parseFromString(kmlTxt, 'text/xml');
          const gj = toGeoJSON.kml(xml);
          const stylePoint = () => ({ radius:6, color:'#1d4ed8', fillColor:'#3b82f6', fillOpacity:.85, weight:2 });
          L.geoJSON(gj, {
            pointToLayer: (f, latlng) => L.circleMarker(latlng, stylePoint()),
            onEachFeature: (feature, layer) => {
              const props = feature.properties||{};
              const name = props.name||'æœªå‘½å';
              const desc = (props.description||'').replace(/<[^>]+>/g,'');
              const latlng = layer.getLatLng();
              layer.bindPopup(`<div class="text-sm">
                <div class="font-medium mb-1">${name}</div>
                <div class="mb-2 whitespace-pre-wrap">${desc}</div>
                <a target="_blank" rel="noopener" class="text-blue-600 underline text-xs" href="https://www.google.com/maps/dir/?api=1&destination=${latlng.lat},${latlng.lng}">ğŸ§­ å°èˆª</a>
              </div>`);
              items.push({ source:'å®˜æ–¹æ¨™è¨»', name, address:'', desc, latlng, layer, type:'æ¨™è¨»' });
            },
            style: { color:'#9333ea', weight:3, opacity:.8 }
          }).addTo(layerRef.current.kml);
        }
      } catch(e){ console.warn('KML parse fail', e); }

      // Shovel
      try {
        // å…ˆèµ°å¾Œç«¯ proxyï¼Œé¿å… CORSï¼›å¤±æ•—å†å˜—è©¦ç›´é€£
        let r = await fetch(SHOVEL_JSON);
        if (!r.ok) r = await fetch('https://shovel-heroes.com/Map/data.json');
        let arr = [];
        if (r.ok) {
          try {
            arr = await r.json();
          } catch {
            // æŸäº›ä¼ºæœå™¨ä»¥ text/plain å›å‚³ï¼Œæ”¹ç”¨æ–‡å­—è½‰ JSON
            const txt = await r.text();
            try { arr = JSON.parse(txt); } catch {}
          }
          (Array.isArray(arr)?arr:[]).forEach(s=>{
            const {lat,lng,title,note,type} = s;
            if (typeof lat!=='number' || typeof lng!=='number') return;
            const marker = L.marker([lat,lng]).addTo(layerRef.current.shovel)
              .bindPopup(`<div class="text-sm">
                <div class="font-medium mb-1">${title||'Shovel ä»»å‹™'}</div>
                <div class="mb-2">${note||''}</div>
                <a target="_blank" rel="noopener" class="text-blue-600 underline text-xs" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">ğŸ§­ å°èˆª</a>
              </div>`);
            items.push({ source:'Shovel', name:title||'ä»»å‹™', address:'', desc:note||'', latlng:L.latLng(lat,lng), layer:marker, type:type||'å¿—å·¥ä»»å‹™' });
          });
        }
      } catch(e){ console.warn('Shovel load fail', e); }

      // æ”¿åºœé»ä½
      try {
        const r = await fetch(GOV_POINTS_URL);
        if (r.ok) {
          const gj = await r.json();
          const govIcon = (type) => {
            const map = {
              medical:{c:'#ef4444',t:'ğŸ…·'}, volunteer:{c:'#0ea5e9',t:'å¿—'},
              mud_storage:{c:'#78350f',t:'æ³¥'}, waste_storage:{c:'#334155',t:'åƒ'},
              meal_distribution:{c:'#f59e0b',t:'ğŸ±'}, general:{c:'#64748b',t:'æ”¿'}
            };
            const info = map[type] || map.general;
            return L.divIcon({
              html:`<div style="background:${info.c};border:2px solid #fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;box-shadow:0 0 0 1px rgba(0,0,0,.3)">${info.t}</div>`,
              className:'', iconSize:[26,26], iconAnchor:[13,13], popupAnchor:[0,-13]
            });
          };
          (gj.features||[]).forEach((f)=>{
            if (f.geometry?.type!=='Point') return;
            const [lng,lat] = f.geometry.coordinates||[];
            if (!isFinite(lat)||!isFinite(lng)) return;
            const p = f.properties||{};
            const mk = L.marker([lat,lng],{icon:govIcon(p.type)}).addTo(layerRef.current.gov)
              .bindPopup(`<div class="text-sm">
                <div class="font-medium mb-1">${p.name||'æ”¿åºœè¨­æ–½'}</div>
                <div class="mb-2 whitespace-pre-wrap">${p.description||''}</div>
                <a target="_blank" rel="noopener" class="text-blue-600 underline text-xs" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">ğŸ§­ å°èˆª</a>
              </div>`);
            items.push({ source:'æ”¿åºœè¨­æ–½', name:p.name||'è¨­æ–½', address:'', desc:p.description||'', latlng:L.latLng(lat,lng), layer:mk, type:'æ”¿åºœè¨­æ–½' });
          });
        }
      } catch(e){ console.warn('gov points fail', e); }

      // è‡ªå»ºé»
      try {
        const arr = JSON.parse(localStorage.getItem(LS_USER_ADDS)||'[]');
        arr.forEach(u=>{
          const marker = L.marker([u.lat,u.lng]).addTo(layerRef.current.user)
            .bindPopup(`<div class="text-sm">
              <div class="font-medium mb-1">${u.name}</div>
              <div class="mb-2">${u.desc||''}</div>
              <a target="_blank" rel="noopener" class="text-blue-600 underline text-xs" href="https://www.google.com/maps/dir/?api=1&destination=${u.lat},${u.lng}">ğŸ§­ å°èˆª</a>
            </div>`);
          items.push({ ...u, source:'è‡ªå»º', address:u.address||'', latlng:L.latLng(u.lat,u.lng), layer:marker });
        });
      } catch(e){}

      // éœ€æ±‚é»
      try {
        const reqPts = (requests||[]).filter(r=>r.location?.lat && r.location?.lng);
        reqPts.forEach(r=>{
          const { lat, lng } = r.location;
          const mk = L.marker([lat,lng]).addTo(layerRef.current.req)
            .bindPopup(`<div class="text-sm">
              <div class="font-medium mb-1">${r.type}</div>
              <div class="mb-1 whitespace-pre-wrap">${r.description||''}</div>
              <div class="text-xs text-gray-500 mb-2">è¯çµ¡ï¼š${r.contactPerson||''} / ${maskPhone(r.contactPhone)||''}</div>
              <a target="_blank" rel="noopener" class="text-blue-600 underline text-xs" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">ğŸ§­ å°èˆª</a>
            </div>`);
          items.push({ source:'éœ€æ±‚', name:r.type, address:r.address||'', desc:r.description||'', latlng:L.latLng(lat,lng), layer:mk, type:r.type });
        });
      } catch(e){}

      setList(prev => [
        ...prev.filter(x=>!['å®˜æ–¹æ¨™è¨»','Shovel','è‡ªå»º','éœ€æ±‚','æ”¿åºœè¨­æ–½'].includes(x.source)),
        ...items
      ]);
    }, [requests]);

    useEffect(() => { redrawStatic(); drawCsvLayers(); drawManualShelters(); }, [drawCsvLayers, redrawStatic, drawManualShelters]);

    // åˆ—è¡¨ç¯©é¸
    const filteredList = useMemo(()=>{
      return list
        .slice()
        .sort((a,b)=> (a.pending===true) - (b.pending===true))
        .filter(it=>{
          const okF = filterKey==='å…¨éƒ¨'
            ? true
            : (it.type && it.type.includes(filterKey)) ||
              (it.source==='å®˜æ–¹æ¨™è¨»' && filterKey==='æ¨™è¨»') ||
              (it.source==='Shovel' && filterKey==='å¿—å·¥ä»»å‹™') ||
              (it.source==='æ”¿åºœè¨­æ–½' && filterKey==='æ”¿åºœè¨­æ–½');
          const q = search.trim().toLowerCase();
          const okQ = q==='' ? true : (it.name||'').toLowerCase().includes(q) || (it.address||'').toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q);
          return okF && okQ;
        });
    }, [list, filterKey, search]);

    // æ§åˆ¶CSV layeré¡¯ç¤º
    const toggleCsv = (k) => {
      setCsvVisible(v => {
        const next = { ...v, [k]: !v[k] };
        const layer = layerRef.current.csv[k];
        if (layer && mapRef.current) {
          if (next[k]) layer.addTo(mapRef.current); else mapRef.current.removeLayer(layer);
        }
        drawCsvLayers();
        return next;
      });
    };

    return (
      <>
        {showOfficial && <DisasterMap isOpen onClose={()=>setShowOfficial(false)} />}
        <div className="bg-white rounded-lg border p-4 ui-over">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-lg font-bold">ğŸ—ºï¸ å…‰å¾©ç½æƒ…æ•´åˆåœ°åœ–ï¼ˆå¯å°èˆªï¼‰</h3>
            <div className="flex items-center gap-2">
              <button onClick={locateMe} className="px-3 py-1.5 text-sm rounded bg-slate-700 text-white hover:bg-slate-800">ğŸ“ å®šä½æˆ‘</button>
              <button onClick={()=>setShowAddForm(true)} className="px-3 py-1.5 text-sm rounded bg-slate-700 text-white hover:bg-emerald-700">â• æ–°å¢é»ä½</button>
              <button onClick={()=>setShowOfficial(true)} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">æŸ¥çœ‹å®˜æ–¹åœ°åœ–</button>
            </div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <div className="lg:col-span-3">
              <div id="gf-map" className="w-full h-[60vh] rounded border"></div>
            </div>
            <div className="lg:col-span-1">
              <div className="flex gap-2 mb-2">
                <select value={filterKey} onChange={(e)=>setFilterKey(e.target.value)} className="w-40 px-2 py-1.5 border rounded text-sm">
                  <option>å…¨éƒ¨</option>
                  <option>æ”¿åºœè¨­æ–½</option>
                  <option>ç‰©è³‡</option>
                  <option>é†«ç™‚</option>
                  <option>ä¾›æ°´</option>
                  <option>è·¯éšœ</option>
                  <option>å¿—å·¥ä»»å‹™</option>
                  <option>æ¨™è¨»</option>
                  <option>æ´—æ¾¡é»</option>
                  <option>åº‡è­·æ‰€</option>
                  <option>ä½å®¿</option>
                  <option>å¿ƒç†</option>
                  <option>å…¶ä»–</option>
                </select>
                <input value={search} onChange={(e)=>setSearch(e.target.value)} className="flex-1 px-2 py-1.5 border rounded text-sm" placeholder="æœå°‹åç¨±/åœ°å€/å‚™è¨»"/>
              </div>
              <div className="text-xs text-gray-500 mb-2">
                ä¾†æºï¼šå®˜æ–¹ KML + Shovel + æ”¿åºœè¨­æ–½ + è‡ªå»ºé» + éœ€æ±‚è¡¨å–® + CSVï¼ˆæ´—æ¾¡é»/åº‡è­·æ‰€/ä½å®¿/é†«ç™‚/å¿ƒç†ï¼‰
              </div>
              <div className="grid grid-cols-2 gap-x-3 gap-y-2 mb-3 text-xs">
                {DATASETS.map(ds=>(
                  <label key={ds.key} className="flex items-center gap-1"><input type="checkbox" checked={!!csvVisible[ds.key]} onChange={()=>toggleCsv(ds.key)}/> {ds.label}</label>
                ))}
              </div>
              <div className="max-h-[60vh] overflow-auto space-y-2">
                {filteredList.map((it, idx)=>(
                  <div key={idx} className="border rounded p-2">
                    <div className="text-sm font-medium">
                      {it.name || 'æœªå‘½å'} <span className="text-[11px] text-slate-500">ï¼ˆ{it.source}ï¼‰</span>
                      {it.pending ? <span className="ml-2 text-[11px] text-amber-600">ç­‰å¾…å®šä½â€¦</span> : null}
                    </div>
                    {it.type && <div className="text-[11px] text-gray-500 mt-0.5">é¡å‹ï¼š{it.type}</div>}
                    {it.address && <div className="text-[12px] text-gray-600 mt-1">ğŸ“ {it.address}</div>}
                    {it.desc && <div className="text-[12px] text-gray-600 mt-1 whitespace-pre-wrap">{it.desc}</div>}
                    <div className="flex gap-2 mt-2">
                      <button
                        onClick={()=>{ if(it.latlng && mapRef.current) { mapRef.current.flyTo(it.latlng, 16); it.layer?.openPopup(); } }}
                        className="px-2 py-1 text-xs rounded bg-slate-700 text-white"
                        disabled={!it.latlng}
                        title={it.latlng?'åœ°åœ–å®šä½':'å°šæœªå–å¾—åº§æ¨™'}>
                        å®šä½
                      </button>
                      {it.latlng ? (
                        <button onClick={()=>{ window.open(`https://www.google.com/maps/dir/?api=1&destination=${it.latlng.lat},${it.latlng.lng}`,'_blank'); }} className="px-2 py-1 text-xs rounded bg-green-600 text-white">å°èˆª</button>
                      ) : (
                        <button onClick={()=>{ if(it.address){ window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address)}`,'_blank'); } }} className="px-2 py-1 text-xs rounded bg-green-600 text-white" disabled={!it.address}>ç”¨åœ°å€é–‹å•Ÿ</button>
                      )}
                    </div>
                  </div>
                ))}
                {filteredList.length===0 && <div className="text-xs text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é»ä½</div>}
              </div>
              {/* æ‰‹æ©Ÿå¯¬åº¦æ™‚é¡¯ç¤ºå¤–éƒ¨é€£çµ */}
              <div className="mt-4 flex md:hidden flex-wrap gap-2">
                {EXTERNAL_LINKS.map(l=>(
                  <a key={l.url} href={l.url} target="_blank" rel="noopener" className="text-xs px-2 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">{l.name}</a>
                ))}
              </div>
            </div>
          </div>
        </div>
        {showAddForm && (
          <AddPointForm
            isOpen={showAddForm}
            onClose={()=>setShowAddForm(false)}
            onSubmit={async ({ name, category, address, note, phone, lat, lng })=>{
              try {
                let plat = Number(lat), plng = Number(lng);
                if (!isFinite(plat) || !isFinite(plng)) {
                  if (address) {
                    const g = await geocodeAddress(address);
                    if (g) { plat = g.lat; plng = g.lng; }
                  }
                }
                if (!isFinite(plat) || !isFinite(plng)) { alert('æ‰¾ä¸åˆ°åº§æ¨™ï¼Œè«‹èª¿æ•´åœ°å€æˆ–å¡«å…¥ç¶“ç·¯åº¦'); return; }
                const mk = L.marker([plat,plng]).addTo(layerRef.current.user)
                  .bindPopup(`<div class="text-sm">
                    <div class="font-medium mb-1">${name}</div>
                    ${address?`<div class='text-xs text-gray-600'>ğŸ“ ${address}</div>`:''}
                    ${phone?`<div class='text-xs text-gray-600'>ğŸ“ ${maskPhone(phone)}</div>`:''}
                    ${note?`<div class='text-xs text-gray-600 whitespace-pre-wrap mt-1'>${note}</div>`:''}
                    <a class="text-blue-600 underline text-xs" target="_blank" rel="noopener" href="https://www.google.com/maps/dir/?api=1&destination=${plat},${plng}">ğŸ§­ å°èˆª</a>
                  </div>`);
                const newItem = { id: 'user::'+uuid(), source:'è‡ªå»º', name, address, desc:note, phone, type:category, latlng:L.latLng(plat,plng), layer:mk };
                const arr = JSON.parse(localStorage.getItem(LS_USER_ADDS)||'[]'); arr.push({ ...newItem, lat:plat, lng:plng });
                localStorage.setItem(LS_USER_ADDS, JSON.stringify(arr));
                setList(prev => [...prev, newItem]);
                mapRef.current?.flyTo([plat,plng], 16); mk.openPopup();
                setShowAddForm(false);
              } catch(e){ alert('æ–°å¢å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡'); }
            }}
          />
        )}
      </>
    );
  };

  async function fetchKMLText() {
    const r = await fetch(KML_URL);
    if (!r.ok) throw new Error('blocked');
    return await r.text();
  }

  // æ–°å¢é»ä½è¡¨å–®
  const AddPointForm = ({ isOpen, onClose, onSubmit }) => {
    const [name, setName] = useState('');
    const [category, setCategory] = useState('å…¶ä»–');
    const [address, setAddress] = useState('');
    const [lat, setLat] = useState('');
    const [lng, setLng] = useState('');
  const [note, setNote] = useState('');
  const [phone, setPhone] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    if (!isOpen) return null;

    const useMyLocation = () => {
      if (!navigator.geolocation) { setError('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        setLat(pos.coords.latitude.toFixed(6));
        setLng(pos.coords.longitude.toFixed(6));
        setAddress(`GPS: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`);
      },()=>setError('å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™'), {enableHighAccuracy:true, timeout:10000});
    };

    const handleSubmit = async (e) => {
      e.preventDefault(); setError(''); setLoading(true);
      try { await onSubmit({ name, category, address, note, phone, lat, lng }); }
      finally { setLoading(false); }
    };

    const cats = ['ç‰©è³‡','é†«ç™‚','ä¾›æ°´','è·¯éšœ','å¿—å·¥ä»»å‹™','æ´—æ¾¡é»','åº‡è­·æ‰€','ä½å®¿','å¿ƒç†','å…¶ä»–'];
    return (
      <div className="fixed inset-0 bg-black/50 modal-z flex items-center justify-center p-4">
        <div className="bg-white rounded-lg w-full max-w-md">
          <div className="p-4 border-b flex items-center justify-between">
            <h3 className="font-bold">æ–°å¢é»ä½</h3>
            <button onClick={onClose} className="text-gray-500">âœ•</button>
          </div>
          <form onSubmit={handleSubmit} className="p-4 space-y-3">
            <div>
              <label className="block text-sm">åç¨±</label>
              <input value={name} onChange={e=>setName(e.target.value)} className="mt-1 w-full border rounded px-2 py-1" placeholder="ä¾‹å¦‚ï¼šåœ– æ–¹ä¾¿ èƒŒåŒ…å®¢æ°‘å®¿"/>
            </div>
            <div>
              <label className="block text-sm">åˆ†é¡</label>
              <select value={category} onChange={e=>setCategory(e.target.value)} className="mt-1 w-full border rounded px-2 py-1">
                {cats.map(c=> <option key={c}>{c}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm">åœ°å€ï¼ˆèˆ‡æˆ–ç¶“ç·¯åº¦ï¼‰</label>
              <input value={address} onChange={e=>setAddress(e.target.value)} className="mt-1 w-full border rounded px-2 py-1" placeholder="èŠ±è“®ç¸£å…‰å¾©é„‰â€¦"/>
              <div className="text-xs text-gray-500 mt-1">å¯ç•™ç©ºæ”¹ç”¨ä¸‹æ–¹ç¶“ç·¯åº¦æˆ–ã€ŒğŸ“ ä»¥ç›®å‰ä½ç½®å¡«å…¥ã€</div>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block text-sm">ç·¯åº¦</label>
                <input value={lat} onChange={e=>setLat(e.target.value)} className="mt-1 w-full border rounded px-2 py-1" placeholder="23.6..."/>
              </div>
              <div>
                <label className="block text-sm">ç¶“åº¦</label>
                <input value={lng} onChange={e=>setLng(e.target.value)} className="mt-1 w-full border rounded px-2 py-1" placeholder="121.4..."/>
              </div>
            </div>
            <div>
              <button type="button" onClick={useMyLocation} className="text-xs px-2 py-1 bg-slate-600 text-white rounded">ğŸ“ ä»¥ç›®å‰ä½ç½®å¡«å…¥</button>
            </div>
            <div>
              <label className="block text-sm">é›»è©±ï¼ˆé¸å¡«ï¼‰</label>
              <input value={phone} onChange={e=>setPhone(e.target.value)} className="mt-1 w-full border rounded px-2 py-1"/>
            </div>
            <div>
              <label className="block text-sm">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
              <textarea rows="3" value={note} onChange={e=>setNote(e.target.value)} className="mt-1 w-full border rounded px-2 py-1"/>
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <div className="flex justify-end gap-2 pt-2">
              <button type="button" onClick={onClose} className="px-3 py-1.5 text-sm rounded bg-slate-100">å–æ¶ˆ</button>
              <button type="submit" disabled={loading} className="px-3 py-1.5 text-sm rounded bg-emerald-600 text-white">{loading?'è™•ç†ä¸­â€¦':'æ–°å¢'}</button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  /* ---------------- éœ€æ±‚ / è¡¨å–® ---------------- */
  const VolunteerSignup = ({ onSubmit }) => {
    const [name,setName]=useState('');
    const [phone,setPhone]=useState('');
    const [note,setNote]=useState('');
    const [error,setError]=useState('');
    const [submitting,setSubmitting]=useState(false);
    const handleSubmit=(e)=>{
      e.preventDefault();
      if(!name||!phone){setError('è«‹è¼¸å…¥å§“åèˆ‡é›»è©±'); return;}
      setError('');
      const payload = {name,phone,note};
      const maybePromise = onSubmit(payload);
      if (maybePromise && typeof maybePromise.then === 'function') {
        setSubmitting(true);
        maybePromise.then(()=>{
          setName(''); setPhone(''); setNote('');
        }).catch((err)=>{
          console.error('volunteer submit failed', err);
          setError(typeof err?.message === 'string' ? err.message : 'é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }).finally(()=>setSubmitting(false));
      } else {
        setName(''); setPhone(''); setNote('');
      }
    };
    return (
      <form onSubmit={handleSubmit} className="mt-3 space-y-3 bg-slate-50 border border-slate-200 rounded-md p-3">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label className="block text-xs font-medium text-slate-700">å§“å</label><input value={name} onChange={(e)=>setName(e.target.value)} className="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md text-sm"/></div>
          <div><label className="block text-xs font-medium text-slate-700">é›»è©±</label><input value={phone} onChange={(e)=>setPhone(e.target.value)} className="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md text-sm"/></div>
        </div>
        <div><label className="block text-xs font-medium text-slate-700">å‚™è¨»ï¼ˆå¯é¸ï¼‰</label><input value={note} onChange={(e)=>setNote(e.target.value)} className="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md text-sm"/></div>
        {error && <p className="text-red-500 text-xs">{error}</p>}
        <div className="flex gap-2 justify-end"><button type="submit" disabled={submitting} className="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded-md disabled:bg-slate-400">{submitting?'é€å‡ºä¸­...':'é€å‡ºå ±å'}</button></div>
      </form>
    );
  };

  const RequestStatusSummary = ({ requests }) => {
    const summary = useMemo(() => {
      const base = {
        newCount: 0,
        inProgressCount: 0,
        completedCount: 0,
        volunteerCount: 0
      };
      (requests || []).forEach(req => {
        if (req.status === RequestStatus.NEW) base.newCount += 1;
        if (req.status === RequestStatus.IN_PROGRESS) base.inProgressCount += 1;
        if (req.status === RequestStatus.COMPLETED) base.completedCount += 1;
        if (Array.isArray(req.volunteers)) base.volunteerCount += req.volunteers.length;
      });
      return base;
    }, [requests])

    const cards = [
      { label: 'æ–°ç™»è¨˜', value: summary.newCount, accent: 'bg-blue-50 text-blue-700 border border-blue-100', icon: 'ğŸ†•' },
      { label: 'å·²å‰å¾€', value: summary.inProgressCount, accent: 'bg-amber-50 text-amber-700 border border-amber-100', icon: 'ğŸšš' },
      { label: 'å·²å®Œæˆ', value: summary.completedCount, accent: 'bg-emerald-50 text-emerald-700 border border-emerald-100', icon: 'âœ…' },
      { label: 'æ”¯æ´äººæ•¸', value: summary.volunteerCount, accent: 'bg-purple-50 text-purple-700 border border-purple-100', icon: 'ğŸ‘¥' }
    ];

    return (
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        {cards.map(card => (
          <div key={card.label} className={`rounded-lg px-4 py-3 shadow-sm ${card.accent}`}>
            <div className="text-xs uppercase tracking-wide font-semibold opacity-80 flex items-center gap-1">
              <span>{card.icon}</span>
              <span>{card.label}</span>
            </div>
            <div className="mt-2 text-3xl font-bold leading-none">{card.value}</div>
          </div>
        ))}
      </div>
    );
  };

  const RequestCard = ({ request, onUpdateStatus, onAddVolunteer, onDelete }) => {
    const { id, type, status, contactPerson, contactPhone, address, description, createdAt } = request;
    const [updating, setUpdating] = useState(false);
    const [deleting, setDeleting] = useState(false);
    const [actionError, setActionError] = useState('');
    const volunteerCount = Array.isArray(request.volunteers) ? request.volunteers.length : 0;
    const latestVolunteer = volunteerCount ? request.volunteers[volunteerCount - 1] : null;
    const statusColors = {
      [RequestStatus.NEW]:'bg-blue-100 text-blue-800',
      [RequestStatus.IN_PROGRESS]:'bg-amber-100 text-amber-800',
      [RequestStatus.COMPLETED]:'bg-emerald-100 text-emerald-800',
    };
    const statusActionText = {
      [RequestStatus.NEW]:'æ¨™è¨˜ç‚ºå·²å‰å¾€',
      [RequestStatus.IN_PROGRESS]:'æ¨™è¨˜ç‚ºå·²å®Œæˆ'
    };

    const handleStatusChange = (nextStatus) => {
      if (!onUpdateStatus) return;
      const result = onUpdateStatus(id, nextStatus);
      if (result && typeof result.then === 'function') {
        setUpdating(true);
        setActionError('');
        result.catch(err => {
          console.error('update status failed', err);
          setActionError(typeof err?.message === 'string' ? err.message : 'ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }).finally(()=>setUpdating(false));
      }
    };

    const handleDelete = () => {
      if (!onDelete) return;
      if (!window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤éœ€æ±‚ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
      const result = onDelete(id);
      if (result && typeof result.then === 'function') {
        setDeleting(true);
        setActionError('');
        result.catch(err => {
          console.error('delete request failed', err);
          setActionError(typeof err?.message === 'string' ? err.message : 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }).finally(()=>setDeleting(false));
      }
    };

    return (
      <div className={`bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200 flex flex-col`}> 
        <div className="p-5 space-y-4 flex-1">
          <div className="flex items-start justify-between gap-3">
            <div className="space-y-2">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="inline-flex items-center px-2.5 py-1 rounded-md bg-slate-100 text-xs font-semibold text-slate-700 tracking-wide uppercase">{type}</span>
                <span className={`px-2.5 py-1 text-xs font-semibold rounded-full ${statusColors[status]}`}>{status}</span>
                <span className="text-xs text-slate-400">å»ºç«‹æ–¼ {new Date(createdAt).toLocaleString('zh-TW')}</span>
              </div>
              <p className="text-slate-700 whitespace-pre-wrap text-sm leading-relaxed">{description}</p>
            </div>
            <button onClick={handleDelete} disabled={deleting}
              className="text-sm font-semibold text-red-600 hover:text-red-700 disabled:text-red-300">
              {deleting ? 'åˆªé™¤ä¸­â€¦' : 'åˆªé™¤ä»»å‹™'}
            </button>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600 bg-slate-50 rounded-lg border border-slate-200 p-3">
            <div className="flex items-center gap-2"><span className="font-semibold text-slate-700">ğŸ‘¤ è¯çµ¡äºº</span><span>{contactPerson}</span></div>
            <div className="flex items-center gap-2 break-all"><span className="font-semibold text-slate-700">ğŸ“ è¯çµ¡é›»è©±</span><span>{maskPhone(contactPhone)}</span></div>
            <div className="sm:col-span-2 flex items-start gap-2">
              <span className="font-semibold text-slate-700">ğŸ“ ä½ç½®</span>
              <span className="flex-1 break-words">{address}</span>
            </div>
            {request.photo && (
              <div className="sm:col-span-2">
                <div className="text-xs font-semibold text-slate-700 mb-1">ğŸ“· ç¾å ´ç…§ç‰‡</div>
                <a href={request.photo} target="_blank" rel="noopener">
                  <img src={request.photo} alt="ç¾å ´ç…§ç‰‡" className="max-h-48 rounded border"/>
                </a>
              </div>
            )}
            {request.location?.lat && request.location?.lng && (
              <div className="sm:col-span-2 flex justify-end">
                <a href={`https://www.google.com/maps/dir/?api=1&destination=${request.location.lat},${request.location.lng}`}
                   target="_blank" rel="noopener noreferrer"
                   className="text-xs bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700">ğŸ§­ åœ°åœ–å°èˆª</a>
              </div>
            )}
          </div>

          <div className="border border-indigo-100 rounded-lg p-3 bg-indigo-50/40">
            <div className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-2 text-indigo-700 font-semibold">
                <span>ğŸ‘¥ å‰å¾€å¿—å·¥</span>
                <span className="text-2xl">{volunteerCount}</span>
              </div>
              {latestVolunteer ? (
                <div className="text-xs text-slate-500 text-right leading-relaxed">
                  <div>æœ€æ–°å‰å¾€ï¼š{latestVolunteer.name}</div>
                  <div className="break-all">{maskPhone(latestVolunteer.phone)}</div>
                  {latestVolunteer.note ? <div className="italic text-slate-400">{latestVolunteer.note}</div> : null}
                </div>
              ) : (
                <div className="text-xs text-slate-400">å°šç„¡å¿—å·¥å ±å</div>
              )}
            </div>
            {Array.isArray(request.volunteers) && request.volunteers.length>0 && (
              <ul className="mt-3 space-y-1 max-h-28 overflow-auto pr-1 text-xs text-slate-600">
                {request.volunteers.map((v,i)=>(
                  <li key={i} className="flex items-start justify-between gap-3 bg-white/60 rounded px-2 py-1">
                    <span className="font-medium text-slate-700">{v.name}</span>
                    <span className="flex-1 text-right break-all">
                      {maskPhone(v.phone)}{v.note?`ï½œ${v.note}`:''}
                    </span>
                  </li>
                ))}
              </ul>
            )}
            {type === RequestType.VOLUNTEER && status !== RequestStatus.COMPLETED && (
              <div className="mt-3">
                <h4 className="text-xs font-semibold text-slate-600 mb-1">æ–°å¢å‰å¾€å¿—å·¥</h4>
                <VolunteerSignup onSubmit={(vol)=> onAddVolunteer ? onAddVolunteer(id, vol) : Promise.resolve()} />
              </div>
            )}
          </div>

          {actionError && <p className="text-sm text-red-500">{actionError}</p>}
        </div>

        <div className="px-5 py-4 bg-slate-100 border-t border-slate-200 flex flex-wrap gap-3 justify-end">
          {status !== RequestStatus.COMPLETED && (
            <button
              onClick={()=>handleStatusChange(status === RequestStatus.NEW ? RequestStatus.IN_PROGRESS : RequestStatus.COMPLETED)}
              disabled={updating}
              className="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-indigo-300">
              {updating ? 'æ›´æ–°ä¸­â€¦' : (statusActionText[status] || 'æ›´æ–°ç‹€æ…‹')}
            </button>
          )}
          <button
            onClick={handleDelete}
            disabled={deleting}
            className="px-4 py-2 text-sm font-semibold text-red-600 bg-white border border-red-200 rounded-md hover:bg-red-50 disabled:text-red-300 disabled:border-red-100">
            {deleting ? 'åˆªé™¤ä¸­â€¦' : 'åˆªé™¤ä»»å‹™'}
          </button>
        </div>
      </div>
    );
  };

  const RequestDashboard = ({ requests, onUpdateStatus, onAddVolunteer, onDelete, activeFilter, searchKeyword }) => {
    const [view, setView] = useState('cards'); // 'cards' | 'list'
    const filtered = requests.filter(r => activeFilter==='å…¨éƒ¨' ? true : r.type===activeFilter)
      .filter(r=>{
        const q = (searchKeyword||'').trim().toLowerCase();
        if (!q) return true;
        const fields = [r.type, r.contactPerson, r.contactPhone, r.address, r.description].map(x=>String(x||'').toLowerCase());
        return fields.some(v=>v.includes(q));
      });
    const order = {[RequestStatus.NEW]:1,[RequestStatus.IN_PROGRESS]:2,[RequestStatus.COMPLETED]:3};
    const sorted = filtered.sort((a,b)=> a.status===b.status ? new Date(b.createdAt)-new Date(a.createdAt) : order[a.status]-order[b.status]);
    return (
      <div className="py-8 ui-over space-y-4">
        <div className="flex items-center justify-between gap-3">
          <RequestStatusSummary requests={requests} />
          <div className="flex items-center gap-2">
            <span className="text-xs text-slate-500">è¦–åœ–</span>
            <button onClick={()=>setView('cards')} className={`px-2 py-1 text-xs rounded border ${view==='cards'?'bg-slate-800 text-white':'bg-white'}`}>å¡ç‰‡</button>
            <button onClick={()=>setView('list')} className={`px-2 py-1 text-xs rounded border ${view==='list'?'bg-slate-800 text-white':'bg-white'}`}>æ¸…å–®</button>
          </div>
        </div>

        {sorted.length ? (
          view==='cards' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              {sorted.map(r=>(
                <RequestCard
                  key={r.id}
                  request={r}
                  onUpdateStatus={onUpdateStatus}
                  onAddVolunteer={onAddVolunteer}
                  onDelete={onDelete}
                />
              ))}
            </div>
          ) : (
            <div className="bg-white border rounded-lg overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-50">
                  <tr className="text-left text-slate-600">
                    <th className="p-3">é¡å‹</th>
                    <th className="p-3">ç‹€æ…‹</th>
                    <th className="p-3">è¯çµ¡äºº</th>
                    <th className="p-3">é›»è©±</th>
                    <th className="p-3">åœ°å€</th>
                    <th className="p-3">æè¿°</th>
                    <th className="p-3 text-right">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  {sorted.map(r=> (
                    <tr key={r.id} className="border-t">
                      <td className="p-3 whitespace-nowrap">{r.type}</td>
                      <td className="p-3 whitespace-nowrap">{r.status}</td>
                      <td className="p-3 whitespace-nowrap">{r.contactPerson}</td>
                      <td className="p-3 whitespace-nowrap">{maskPhone(r.contactPhone)}</td>
                      <td className="p-3">{r.address}</td>
                      <td className="p-3">{r.description}</td>
                      <td className="p-3 whitespace-nowrap text-right">
                        <div className="inline-flex gap-2">
                          {r.status!==RequestStatus.COMPLETED && (
                            <button onClick={()=>onUpdateStatus(r.id, r.status===RequestStatus.NEW?RequestStatus.IN_PROGRESS:RequestStatus.COMPLETED)} className="px-2 py-1 text-xs bg-indigo-600 text-white rounded">æ›´æ–°</button>
                          )}
                          <button onClick={()=>onDelete(r.id)} className="px-2 py-1 text-xs border border-red-200 text-red-600 rounded">åˆªé™¤</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )
        ) : (
          <div className="text-center py-12 bg-white border border-dashed border-slate-300 rounded-lg">
            <div className="mx-auto h-12 w-12 text-gray-400">â„¹ï¸</div>
            <h3 className="mt-2 text-lg font-medium">ç›®å‰æ²’æœ‰éœ€æ±‚</h3>
            <p className="mt-1 text-sm text-gray-500">é»æ“Šã€Œç™»è¨˜ç½æƒ…éœ€æ±‚ã€ä¾†æ–°å¢ç¬¬ä¸€ç­†è³‡æ–™ã€‚</p>
          </div>
        )}
      </div>
    );
  };

  const RequestForm = ({ isOpen, onClose, onSubmit }) => {
    const [type, setType] = useState(RequestType.VOLUNTEER);
    const [contactPerson, setContactPerson] = useState('');
    const [contactPhone, setContactPhone] = useState('');
    const [address, setAddress] = useState('');
    const [description, setDescription] = useState('');
    const [photo, setPhoto] = useState(null);
    const [error, setError] = useState('');
    const [location, setLocation] = useState(null);
    const [gettingLocation, setGettingLocation] = useState(false);
    const [submitting, setSubmitting] = useState(false);
    if (!isOpen) return null;

    // å®šä½è‡ªå·±çš„å³æ™‚ä½ç½®
    const getCurrentLocation = () => {
      if (!navigator.geolocation) { setError('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½'); return; }
      setGettingLocation(true);
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          setLocation({ lat: latitude, lng: longitude });
          setAddress(`GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
          setGettingLocation(false);
        },
        () => { setError('ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åœ°å€'); setGettingLocation(false); },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    };

    const handleSubmit = (e) => {
      e.preventDefault();
      if (!contactPerson || !contactPhone || !address || !description) { setError('æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«é …ç›®ã€‚'); return; }
      setError('');
      const payload = { type, contactPerson, contactPhone, address, description, photo, location: location ? {lat:location.lat,lng:location.lng} : null };
      const maybePromise = onSubmit(payload);
      if (maybePromise && typeof maybePromise.then === 'function') {
        setSubmitting(true);
        maybePromise.then(()=>{
          setContactPerson(''); setContactPhone(''); setAddress(''); setDescription(''); setPhoto(null); setLocation(null);
          onClose();
        }).catch(err => {
          console.error('submit request failed', err);
          setError(typeof err?.message === 'string' ? err.message : 'é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }).finally(()=>setSubmitting(false));
      } else {
        setContactPerson(''); setContactPhone(''); setAddress(''); setDescription(''); setPhoto(null); setLocation(null); onClose();
      }
    };

    // è®€å–/å£“ç¸®åœ–ç‰‡ç‚º dataURLï¼ˆmax é‚Š 1280, JPEG å“è³ª0.85ï¼‰
    const handleFile = async (file) => {
      if (!file) return setPhoto(null);
      const img = new Image();
      const fr = new FileReader();
      const done = await new Promise((resolve) => {
        fr.onload = () => { img.src = fr.result; };
        img.onload = () => resolve();
        fr.readAsDataURL(file);
      });
      const maxSide = 1280;
      const canvas = document.createElement('canvas');
      let { width, height } = img;
      const ratio = Math.min(1, maxSide/Math.max(width,height));
      width = Math.round(width*ratio); height = Math.round(height*ratio);
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,width,height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
      if (dataUrl.length > 2_000_000) {
        setError('åœ–ç‰‡éå¤§ï¼Œè«‹é¸æ“‡è¼ƒå°çš„ç…§ç‰‡æˆ–å†å£“ç¸®');
        return;
      }
      setError('');
      setPhoto(dataUrl);
    };

    return (
      <div className="fixed inset-0 bg-black/50 modal-z flex justify-center items-center p-4">
        <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto">
          <div className="p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-slate-800">ç™»è¨˜æ–°çš„éœ€æ±‚</h2>
              <button onClick={onClose} className="text-slate-500 hover:text-slate-800">âœ•</button>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2">éœ€æ±‚é¡å‹</label>
                  <div className="flex space-x-4">
                    <label className="flex items-center">
                      <input type="radio" name="type" value={RequestType.VOLUNTEER} checked={type===RequestType.VOLUNTEER} onChange={(e)=>setType(e.target.value)} className="h-4 w-4 text-indigo-600"/>
                      <span className="ml-2 text-slate-800">å¿—å·¥äººåŠ›</span>
                    </label>
                    <label className="flex items-center">
                      <input type="radio" name="type" value={RequestType.SUPPLY} checked={type===RequestType.SUPPLY} onChange={(e)=>setType(e.target.value)} className="h-4 w-4 text-indigo-600"/>
                      <span className="ml-2 text-slate-800">ç‰©è³‡éœ€æ±‚</span>
                    </label>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700">è¯çµ¡äººï¼ˆå¯å¡«æš±ç¨±æˆ–å§“æ°ï¼‰</label>
                  <input value={contactPerson} onChange={(e)=>setContactPerson(e.target.value)} placeholder="ä¾‹ï¼šå°æ˜ã€ç‹å…ˆç”Ÿã€é˜¿å¿—" className="mt-1 block w-full px-3 py-2 bgç™½ border border-slate-300 rounded-md shadow-sm sm:text-sm"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700">è¯çµ¡é›»è©±</label>
                  <input value={contactPhone} onChange={(e)=>setContactPhone(e.target.value)} className="mt-1 block w-full px-3 py-2 bgç™½ border border-slate-300 rounded-md shadow-sm sm:text-sm"/>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 flex items-center justify-between">
                    <span>ç¾å ´ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</span>
                    <span className="text-[12px] text-slate-500">è‹¥éœ€æ±‚éœ€å¤§å‹æ©Ÿå…·ï¼Œè«‹ä¸Šå‚³ç¾å ´ç…§ç‰‡ï¼Œé¿å…å¿—å·¥ç™½è·‘ä¸€è¶Ÿã€‚</span>
                  </label>
                  <input type="file" accept="image/*" onChange={(e)=>handleFile(e.target.files?.[0])} className="mt-1 block w-full text-sm"/>
                  {photo && (
                    <div className="mt-2">
                      <img src={photo} alt="é è¦½" className="max-h-40 rounded border"/>
                    </div>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700">åœ°å€æˆ–ä½ç½®</label>
                  <div className="flex gap-2">
                    <input value={address} onChange={(e)=>setAddress(e.target.value)} className="flex-1 px-3 py-2 bgç™½ border border-slate-300 rounded-md shadow-sm sm:text-sm" placeholder="è«‹è¼¸å…¥åœ°å€æˆ–é»æ“Šå®šä½" />
                    <button type="button" onClick={getCurrentLocation} disabled={gettingLocation} className="px-3 py-2 bg-blue-600 textç™½ rounded-md hover:bg-blue-700 disabled:bg-gray-400 text-sm">
                      {gettingLocation ? 'å®šä½ä¸­...' : 'ğŸ“ å®šä½'}
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700">è©³ç´°éœ€æ±‚èªªæ˜</label>
                  <textarea rows={4} value={description} onChange={(e)=>setDescription(e.target.value)} className="mt-1 block w-full px-3 py-2 bgç™½ border border-slate-300 rounded-md shadow-sm sm:text-sm"></textarea>
                </div>
                {error && <p className="text-red-500 text-sm">{error}</p>}
              </div>

              <div className="mt-6 flex justify-end space-x-3">
                <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200" disabled={submitting}>å–æ¶ˆ</button>
                <button type="submit" disabled={submitting} className="px-4 py-2 text-sm font-medium textç™½ bg-indigo-600 rounded-md shadow-sm hover:bg-indigo-700 disabled:bg-indigo-400">{submitting?'é€å‡ºä¸­...':'é€å‡ºéœ€æ±‚'}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    );
  };

  /* ---------------- æ„è¦‹é¢æ¿å…ƒä»¶ ---------------- */
  const FeedbackModal = ({ isOpen, onClose, list, onCreate, onUpdateStatus, onDelete }) => {
    const [name,setName]=React.useState('');
    const [contact,setContact]=React.useState('');
    const [message,setMessage]=React.useState('');
    const [error,setError]=React.useState('');
    if (!isOpen) return null;

    const submit = (e)=>{
      e.preventDefault();
      if (!message.trim()) { setError('è«‹è¼¸å…¥æ„è¦‹å…§å®¹'); return; }
      setError('');
      onCreate({ name, contact, message }).then(()=>{ setName(''); setContact(''); setMessage(''); }).catch(err=>{
        setError(err?.message || 'é€å‡ºå¤±æ•—');
      });
    };

    const StatusPill = ({v}) => (
      <span className={`px-2 py-0.5 rounded text-xs ${v==='æœªè™•ç†'?'bg-slate-200 text-slate-700':v==='è™•ç†ä¸­'?'bg-amber-100 text-amber-800':'bg-emerald-100 text-emerald-800'}`}>{v}</span>
    );

    return (
      <div className="fixed inset-0 bg-black/50 modal-z flex justify-center items-center p-4">
        <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-full overflow-y-auto">
          <div className="p-4 border-b flex items-center justify-between"><h3 className="text-lg font-bold">ğŸ’¬ ç¶²ç«™æ„è¦‹å›é¥‹</h3><button onClick={onClose} className="text-slate-500">âœ•</button></div>
          <div className="p-4 space-y-4">
            <form onSubmit={submit} className="space-y-3 bg-slate-50 rounded border p-3">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div><label className="block text-xs text-slate-600">ç¨±å‘¼ï¼ˆé¸å¡«ï¼‰</label><input value={name} onChange={e=>setName(e.target.value)} className="w-full px-3 py-2 border rounded text-sm"/></div>
                <div><label className="block text-xs text-slate-600">è¯çµ¡æ–¹å¼ï¼ˆé¸å¡«ï¼‰</label><input value={contact} onChange={e=>setContact(e.target.value)} className="w-full px-3 py-2 border rounded text-sm"/></div>
                <div className="md:col-span-1 flex items-end"><button type="submit" className="px-4 py-2 bg-purple-600 text-white rounded text-sm w-full md:w-auto">é€å‡ºæ„è¦‹</button></div>
              </div>
              <div><label className="block text-xs text-slate-600">æ„è¦‹å…§å®¹</label><textarea rows={3} value={message} onChange={e=>setMessage(e.target.value)} className="w-full px-3 py-2 border rounded text-sm"/></div>
              {error && <p className="text-red-600 text-sm">{error}</p>}
            </form>

            <div className="text-xs text-slate-500">ç®¡ç†ï¼šå¯å°‡ç‹€æ…‹è¨­ç‚ºã€Œæœªè™•ç† / è™•ç†ä¸­ / å·²å®Œæˆã€ï¼Œä¹Ÿå¯åˆªé™¤ç•™è¨€ã€‚</div>
            <div className="space-y-2">
              {(list||[]).map(item => (
                <div key={item.id} className="bg-white border rounded p-3 flex flex-col gap-2">
                  <div className="flex items-center justify-between">
                    <div className="text-sm font-medium text-slate-800">{item.name || 'åŒ¿å'}</div>
                    <div className="flex items-center gap-2">
                      <StatusPill v={item.status}/>
                      <button onClick={()=>onDelete(item.id)} className="text-red-600 text-xs">åˆªé™¤</button>
                    </div>
                  </div>
                  {item.contact && <div className="text-xs text-slate-500">ğŸ“ {item.contact}</div>}
                  <div className="text-sm whitespace-pre-wrap">{item.message}</div>
                  <div className="flex gap-2 justify-end mt-2">
                    <button onClick={()=>onUpdateStatus(item.id,'æœªè™•ç†')} className="px-2 py-1 text-xs border rounded">æœªè™•ç†</button>
                    <button onClick={()=>onUpdateStatus(item.id,'è™•ç†ä¸­')} className="px-2 py-1 text-xs border rounded">è™•ç†ä¸­</button>
                    <button onClick={()=>onUpdateStatus(item.id,'å·²å®Œæˆ')} className="px-2 py-1 text-xs border rounded">å·²å®Œæˆ</button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };
  </script>
</body>
</html>
