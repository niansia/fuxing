<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>本網站 QR Code</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%230ea5e9'/%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{--bg:#0f172a;--fg:#f8fafc}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji';}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    header{padding:16px 20px;border-bottom:1px solid #1f2a44}
    header h1{margin:0;font-size:18px}
    main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:20px}
    .panel{display:flex;flex-direction:column;align-items:center;gap:12px;background:#0b1220;border:1px solid #1f2a44;border-radius:12px;padding:24px}
    canvas{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center}
    .controls input[type=text]{min-width:320px;max-width:80vw;padding:10px 12px;border-radius:8px;border:1px solid #233252;background:#0b1220;color:#e5e7eb}
    .controls input[type=number]{width:110px;padding:10px 12px;border-radius:8px;border:1px solid #233252;background:#0b1220;color:#e5e7eb}
    .btn{appearance:none;border:1px solid #233252;background:#111a2e;color:#e5e7eb;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#1d4ed8}
    .btn:hover{filter:brightness(1.1)}
    .hint{opacity:.8;font-size:12px}
    footer{padding:12px 16px;text-align:center;opacity:.7}
    @media print{
      header,.controls,footer{display:none}
      body{background:#fff;color:#000}
      main{padding:0}
      .panel{border:none;box-shadow:none}
      canvas{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>本網站 QR Code（可下載/列印）</h1>
    </header>
    <main>
      <div class="panel">
        <canvas id="qr" width="800" height="800" aria-label="Website QR Code"></canvas>
        <div id="urlText" class="hint"></div>
      </div>
      <div class="controls">
        <input id="urlInput" type="text" placeholder="要產生 QR 的網址" />
        <input id="sizeInput" type="number" min="128" max="2048" step="64" value="640" />
        <button id="updateBtn" class="btn">更新 QR</button>
        <button id="downloadBtn" class="btn primary">下載 PNG</button>
        <button id="printBtn" class="btn">列印</button>
      </div>
      <div class="hint">提示：如需分享其他頁面，可把網址貼到欄位後按「更新 QR」。列印時會自動隱藏控制列。</div>
    </main>
    <footer>© 災情互助平台</footer>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const urlParam = new URLSearchParams(location.search).get('url');
    const defaultUrl = urlParam || (location.origin + '/simple.html');

    const urlInput = $('urlInput');
    const sizeInput = $('sizeInput');
    const urlText = $('urlText');
    const canvas = $('qr');

    urlInput.value = defaultUrl;
    urlText.textContent = defaultUrl;

    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src; s.onload = ()=>resolve(); s.onerror = reject; document.head.appendChild(s);
      });
    }

    async function renderQR(u, size){
      // 1) 優先使用 QRCode.toCanvas（qrcode 套件）
      if (window.QRCode && typeof window.QRCode.toCanvas === 'function') {
        await window.QRCode.toCanvas(canvas, u, { width: size, margin: 2 });
        return true;
      }
      // 2) 動態載入 QRious 當備援
      if (!window.QRious) {
        try { await loadScript('https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js'); } catch {}
      }
      if (window.QRious) {
        // QRious 會直接把圖畫上 canvas
        new window.QRious({ element: canvas, value: u, size, level: 'H' });
        return true;
      }
      // 3) 最後備援：用線上服務產生 PNG，再畫到 canvas
      await new Promise((resolve)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>{ const ctx = canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size); ctx.drawImage(img,0,0,size,size); resolve(); };
        img.onerror = resolve;
        img.src = 'https://api.qrserver.com/v1/create-qr-code/?size='+size+'x'+size+'&data='+encodeURIComponent(u);
      });
      return true;
    }

    async function draw() {
      const u = urlInput.value.trim() || defaultUrl;
      const size = Math.min(2048, Math.max(128, parseInt(sizeInput.value)||640));
      canvas.width = canvas.height = size;
      urlText.textContent = u;
      try {
        await renderQR(u, size);
      } catch (e) {
        console.error('QR render error', e);
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
        ctx.fillStyle = '#000'; ctx.font = '16px sans-serif';
        ctx.fillText('QR 產生失敗，請確認網址', 20, 30);
      }
    }

    $('updateBtn').addEventListener('click', draw);
    $('downloadBtn').addEventListener('click', () => {
      const a = document.createElement('a');
      a.download = 'site-qr.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    });
    $('printBtn').addEventListener('click', () => window.print());

    draw();
  </script>
</body>
</html>
